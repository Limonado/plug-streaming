<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>HLS Player</title>
	<style>

		video {
			background-color: black;
			//margin: 0 auto;
			width: 40%;
			height: 20%;
		}

		.video-progress {
			right: 0; 
			bottom: 0;
			min-width: 100%; 
			min-height: 100%;
			width: auto; 
			height: auto; 
			z-index: -100;
			background-size: cover;
			overflow: hidden;
		}

		progress[value] {
			appearance: none;
			border: none;
			margin-bottom: 7px;
			width:40%;
			height:10px;
		}
	
		#video-submit {
			width: 40%;
		}
	</style>
</head>

<body>
	<div id="auth">
		clique aqui para login
		<button type="button" onclick="closeAuth()">LOGIN</button>
    </div>
    
		<div class="video-progress">
			<video id="video" autoPlay muted></video>
			<br>
			<progress id="progress-bar" value="0" min="0"></progress>
		</div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>
			const progressBar = document.getElementById('progress-bar');
			const video = document.getElementById('video');
			function updateProgress() {
				progressBar.value = Math.floor(video.currentTime);
			}
      function closeAuth() {
        document.getElementById('auth').remove();
        login();
      }
      function login() {
        //document.getElementById('video').muted = true;
        const socket = io();
        socket.on('uptime', (time) => {
          var item = document.createElement("li");
          item.textContent = time;
          document.getElementById('playlist').appendChild(item);
        });
        socket.on('updatePlaylist', (data, ind) => {
          document.getElementById('playlist').innerHTML = '';
          for (var i=0; i<data.length; i++) {
            var item = document.createElement("li");
            item.textContent = data[i].ownerChannelName+' -- '+data[i].title;
            document.getElementById('playlist').appendChild(item);
          }
        });
        socket.on("play", (videoSrc, time, ind, duration) => {
					if (ind > 0) { document.getElementById('playlist').removeChild(0); }
          
          if (Hls.isSupported()) {
            const hls = new Hls({
							autoStartLoad: true,
							startPosition: time,
							debug: false
            });
						progressBar.setAttribute('max', duration);
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              video.play();
            });
          }else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoSrc;
            video.addEventListener('loadedmetadata', () => {
              video.play();
            });
          }
					
					video.addEventListener('timeupdate', updateProgress);
          video.muted = false;
          video.currentTime = time/1000;
        });
      };
      

    function formSubmit(e){
      $.ajax({
          type: "POST",
          url: '/addvideo',
          data: { url: document.getElementById('data').value },
          success: function (data) {

          },
          error: function (data) {
              console.log('An error occurred.');
              console.log(data);
          }
      });
      document.getElementById('data').value = "";
    }

    function getPlaylist() {
      $.get("/getplaylist", function(data) {
        document.getElementById('playlist').innerHTML = '';
        for (var i=0; i<data.length; i++) {
          var item = document.createElement("li");
          item.textContent = data[i].ownerChannelName+' -- '+data[i].title;
          document.getElementById('playlist').appendChild(item);
        }
      });
    }
    </script>

		<div id='video-submit'>
    <form onsubmit="formSubmit()">
      <input type="text" id='data'>
      <button type="button" onclick="formSubmit()">Send</button>
    </form>
		</div>
    <h2>PLAYLIST</h2>
    <ul id='playlist'>

    </ul>
    https://www.youtube.com/watch?v=EtrodNQKZ8I
  </body>

</html>